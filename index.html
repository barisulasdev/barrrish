<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Vienna Land Allocation</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      margin: 0;
      background: white;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }

    svg {
      width: 100%;
      height: 100vh;
      display: block;
    }

    text {
      font-size: 10px;
      pointer-events: none;
    }

    .district-label {
      fill: #222;
      font-weight: bold;
    }

    .category-label {
      fill: #000;
    }
  </style>
</head>
<body>
<div id="chart"></div>

<script>
const rawData = `
1. Innere Stadt,142,27,3,115
2. Leopoldstadt,434,672,404,415
3. Landstraße,416,109,1,214
4. Wieden,114,18,0,45
5. Margareten,129,9,0,63
6. Mariahilf,97,3,2,44
7. Neubau,117,4,0,40
8. Josefstadt,76,2,0,31
9. Alsergrund,179,23,0,95
10. Favoriten,1119,1427,43,594
11. Simmering,851,926,46,503
12. Meidling,488,102,0,220
13. Hietzing,882,2650,15,224
14. Penzing,995,2025,45,311
15. Rudolfsheim-Fünfhaus,219,34,4,136
16. Ottakring,450,261,0,156
17. Hernals,409,602,4,125
18. Währing,356,171,0,107
19. Döbling,906,1191,110,287
20. Brigittenau,205,52,118,196
21. Floridsdorf,1886,1763,151,645
22. Donaustadt,2755,5583,920,972
23. Liesing,1727,953,43,484
`;

const data = {
  name: "Vienna",
  children: rawData.trim().split("\n").map(row => {
    const [district, bauland, gruenland, gewaesser, verkehr] = row.split(",");
    return {
      name: district.trim(),
      children: [
        { name: "Bauland", value: +bauland },
        { name: "Grünland", value: +gruenland },
        { name: "Gewässer", value: +gewaesser },
        { name: "Verkehr", value: +verkehr }
      ]
    };
  })
};

function chart(data) {
  const width = 1000;
  const height = 1000;
  const format = d3.format(",d");

  const colorMap = {
    "Bauland": "#e41a1c",
    "Grünland": "#4daf4a",
    "Gewässer": "#377eb8",
    "Verkehr": "#984ea3"
  };

  const pack = d3.pack()
    .size([width, height])
    .padding(3);

  const root = pack(d3.hierarchy(data)
    .sum(d => d.value)
    .sort((a, b) => b.value - a.value));

  const svg = d3.create("svg")
    .attr("viewBox", [0, 0, width, height]);

  const defs = svg.append("defs");

  const g = svg.append("g")
    .selectAll("g")
    .data(root.descendants())
    .join("g")
    .attr("transform", d => `translate(${d.x},${d.y})`);

  g.append("title")
    .text(d =>
      d.depth === 2
        ? `${d.parent.data.name} / ${d.data.name}: ${format(d.value)} ha`
        : d.data.name
    );

  g.append("circle")
    .attr("r", d => d.r)
    .attr("fill", d => {
      if (d.depth === 0) return "#fff";
      if (d.depth === 1) return "#fff";
      return colorMap[d.data.name] || "#aaa";
    })
    .attr("stroke", d => d.depth ? "#999" : "#000")
    .style("cursor", d => d.depth === 2 ? "pointer" : "default")
    .on("click", (event, d) => {
      if (d.depth === 2) {
        alert(`${d.parent.data.name} / ${d.data.name}\n${format(d.value)} ha`);
      }
    })
    .on("mouseover", (event, d) => {
      if (d.depth === 2) {
        svg.selectAll("circle")
          .attr("fill-opacity", n => (n.depth !== 2 || n.data.name === d.data.name) ? 1 : 0.1);
      }
    })
    .on("mouseout", () => {
      svg.selectAll("circle").attr("fill-opacity", 1);
    });

  // Label inside each bubble (category name + value)
  g.filter(d => d.depth === 2 && d.r > 20)
    .append("text")
    .attr("class", "category-label")
    .attr("text-anchor", "middle")
    .selectAll("tspan")
    .data(d => [d.data.name, format(d.value)])
    .join("tspan")
    .attr("x", 0)
    .attr("y", (_, i) => `${i * 1.1 - 0.6}em`)
    .attr("fill-opacity", (_, i) => i ? 0.7 : 1)
    .text(d => d);

  // Top-only arc labels (one side)
  g.filter(d => d.depth === 1).each(function (d, i) {
    const id = `arc-${i}`;
    const r = d.r - 1;

    // Create arc path for top half (non-mirrored)
    const arcPath = d3.arc()
      .innerRadius(r)
      .outerRadius(r)
      .startAngle(-Math.PI / 2)
      .endAngle(Math.PI / 2)(); // top half only

    defs.append("path")
      .attr("id", id)
      .attr("d", arcPath)
      .attr("transform", `translate(${d.x},${d.y})`);

    svg.append("text")
      .attr("class", "district-label")
      .append("textPath")
      .attr("xlink:href", `#${id}`)
      .attr("startOffset", "0%") // left side
      .text(d.data.name.replace(/^\d+\.\s*/, ""));
  });

  return svg.node();
}

document.getElementById("chart").appendChild(chart(data));
</script>
</body>
</html>
